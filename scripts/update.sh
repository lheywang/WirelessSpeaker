#!/usr/bin/env bash

# ===========================================================================================================
# scripts/update.sh
# 
# Handle the update of the firmware on the target device
#
# ===========================================================================================================

# First, load config
set -a ; . ./.config ; set +a

# Running commands...
echo "
This tool will :
- Compile the software, and copy it to the home/[user] of the pi"
echo "--------------------------------------------------------------------"
echo "WARNING : THIS TOOL DOES NOT UPDATE THE DEVICE TREE !"
echo "--------------------------------------------------------------------"

# =============================================================================
# COMPILATION
# =============================================================================

echo "Compiling everything..."
echo "--------------------------------------------------------------------"
cd .. && make all
echo "--------------------------------------------------------------------"
echo "Compiling done !"
echo "--------------------------------------------------------------------"

# =============================================================================
# MOVING FILES
# =============================================================================

echo "Copying files to the IP..."
echo "--------------------------------------------------------------------"

# Executable
ssh -i ${KEY} pi@${IP} -f "touch /home/pi/${APPNAME}.elf"
scp -i ${KEY} build/${APPNAME} pi@${IP}:/home/pi/${APPNAME}.elf 

echo "--------------------------------------------------------------------"
echo "Copying files done !"
echo "--------------------------------------------------------------------"

# =============================================================================
# CONFIGURATION
# =============================================================================

echo "Applying files modifications..."
echo "--------------------------------------------------------------------"
ssh -i ${KEY} pi@${IP} -f "chmod +x /home/pi/${APPNAME}.elf"
echo "--------------------------------------------------------------------"
echo "Finished applying modifications !"
echo "--------------------------------------------------------------------"

# =============================================================================
# REBOOTING
# =============================================================================

echo "
Update done !
The RaspberryPi will now reboot."
echo "--------------------------------------------------------------------"
ssh -i ${KEY} pi@${IP} -f "sudo reboot"
exit